#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#          http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

name: "Code Review by Gemini AI"
description: "Automatically create a comment about differences in a pull request by Gemini AI"

author: "rubensflinco"

inputs:
  gemini_api_key:
    description: "The Gemini AI API token to use for the action"
    required: true
  github_token:
    description: "The GitHub token to use for the action"
    required: true
  dockerhub_username:
    description: "Optional Docker Hub username to authenticate image pulls during build (helps avoid rate limits)"
    required: false
    default: ""
  dockerhub_token:
    description: "Optional Docker Hub access token/password for docker login (secret recommended)"
    required: false
    default: ""
  github_repository:
    description: "The GitHub repository to use for the action"
    required: true
    default: "${{ github.repository }}"
  github_pull_request_number:
    description: "The GitHub pull request number to use for the action"
    required: true
    default: "${{ github.event.pull_request.number }}"
  git_commit_hash:
    description: "The GitHub commit hash to use for the action"
    required: true
    default: "${{ github.event.pull_request.head.sha }}"
  model:
    description: "GPT model"
    required: true
    default: "text-davinci-003"
  extra_prompt:
    description: "Extra prompt for GPT"
    required: false
    default: ""
  temperature:
    description: "Temperature for GPT"
    required: false
    default: "0.7"
  top_p:
    description: "Top p for GPT"
    required: false
    default: "1"
  presence_penalty:
    description: "Presence penalty for GPT"
    required: false
    default: "0.0"
  pull_request_diff_file:
    description: "Pull request diff file"
    required: true
  pull_request_chunk_size:
    description: "Pull request chunk size"
    required: false
    default: "2000000"
  log_level:
    description: "Log level"
    required: false
    default: "INFO"

outputs:
  entire_prompt_body:
    description: "Entire prompt body"
    value: ${{ steps.gpt.outputs.entire_prompt_body }}
  review_result:
    description: "Review result"
    value: ${{ steps.gpt.outputs.review_result }}

branding:
  icon: "code"
  color: "blue"

runs:
  using: composite
  steps:
    - name: "Docker Hub login (optional)"
      if: ${{ inputs.dockerhub_username != '' && inputs.dockerhub_token != '' }}
      shell: bash
      env:
        DOCKERHUB_USERNAME: ${{ inputs.dockerhub_username }}
        DOCKERHUB_TOKEN: ${{ inputs.dockerhub_token }}
      run: |
        set -euo pipefail
        printf '%s' "$DOCKERHUB_TOKEN" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin

    - name: "Build action image"
      shell: bash
      env:
        ACTION_IMAGE_TAG: gemini-code-review-action:${{ github.run_id }}-${{ github.run_attempt }}
      run: |
        set -euo pipefail
        docker build -t "$ACTION_IMAGE_TAG" "$GITHUB_ACTION_PATH"

    - name: "Run action"
      id: gpt
      shell: bash
      env:
        ACTION_IMAGE_TAG: gemini-code-review-action:${{ github.run_id }}-${{ github.run_attempt }}
        GEMINI_API_KEY: ${{ inputs.gemini_api_key }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
        GITHUB_REPOSITORY: ${{ inputs.github_repository }}
        GITHUB_PULL_REQUEST_NUMBER: ${{ inputs.github_pull_request_number }}
        GIT_COMMIT_HASH: ${{ inputs.git_commit_hash }}
      run: |
        set -euo pipefail

        DIFF_FILE="${INPUT_PULL_REQUEST_DIFF_FILE}"

        # Ensure the diff file is accessible inside the container:
        # - Always mount the workspace (at the same absolute path)
        # - Mount /tmp (common for workflows that write diffs to /tmp)
        VOLUMES=( "-v" "${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE}" "-v" "/tmp:/tmp" )

        # If an absolute diff path is provided outside workspace/tmp, mount its directory too.
        if [[ "${DIFF_FILE}" = /* ]]; then
          DIFF_DIR="$(dirname "${DIFF_FILE}")"
          if [[ "${DIFF_DIR}" != "${GITHUB_WORKSPACE}"* && "${DIFF_DIR}" != /tmp* ]]; then
            VOLUMES+=( "-v" "${DIFF_DIR}:${DIFF_DIR}" )
          fi
        fi

        # Allow the container to write step outputs back to the runner.
        OUTPUT_DIR="$(dirname "${GITHUB_OUTPUT}")"
        VOLUMES+=( "-v" "${OUTPUT_DIR}:${OUTPUT_DIR}" )

        ARGS=(
          "--model=${INPUT_MODEL}"
          "--extra-prompt=${INPUT_EXTRA_PROMPT}"
          "--temperature=${INPUT_TEMPERATURE}"
          "--top-p=${INPUT_TOP_P}"
          "--diff-chunk-size=${INPUT_PULL_REQUEST_CHUNK_SIZE}"
          "--diff-file=${DIFF_FILE}"
          "--log-level=${INPUT_LOG_LEVEL}"
        )

        docker run --rm \
          "${VOLUMES[@]}" \
          -w "${GITHUB_WORKSPACE}" \
          -e GEMINI_API_KEY \
          -e GITHUB_TOKEN \
          -e GITHUB_REPOSITORY \
          -e GITHUB_PULL_REQUEST_NUMBER \
          -e GIT_COMMIT_HASH \
          -e LOCAL \
          -e GITHUB_OUTPUT \
          "$ACTION_IMAGE_TAG" \
          "${ARGS[@]}"
